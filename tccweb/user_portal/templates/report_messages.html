{% extends 'base.html' %}
{% load chat_filters text_extras %}
{% block title %}Report Messages{% endblock %}
{% block extra_head %}{% endblock %}

{% block content %}
<div class="page-container">
    <div class="container-xxl">
        <header class="page-header">
            <div class="title-group">
                <span class="title-icon">
                    <i class="fas fa-file-alt"></i>
                </span>
                <div>
                    <h1 class="h2 mb-1">Report #{{ report.id }}</h1>
                    <p class="mb-0">Review the timeline of updates and stay in touch with your assigned counselor.</p>
                </div>
            </div>
            <div class="page-actions">
                <span class="action-chip action-chip-info">
                    <i class="fas fa-barcode"></i>
                    <span>Tracking code {{ report.tracking_code }}</span>
                </span>
                <a href="{% url 'user_messages' %}" class="action-chip action-chip-info">
                    <i class="fas fa-arrow-left"></i>
                    <span>Back to messages</span>
                </a>
            </div>
        </header>

        <section class="page-section">
            <div class="page-card mb-4">
                <div class="page-card-header fw-semibold">Case timeline</div>
                <div class="page-card-body">
                    {% include 'partials/case_timeline.html' with events=timeline_events %}
                </div>
            </div>

            <section class="chat" data-chat>
                <header class="chat__header">
                    <div class="chat__header-main">
                        <div class="chat__header-avatar" aria-hidden="true">
                            {% if report.assigned_to %}
                                {{ report.assigned_to.get_full_name|default:report.assigned_to.username|first|upper }}
                            {% else %}
                                <i class="fas fa-user-shield" aria-hidden="true"></i>
                            {% endif %}
                        </div>
                        <div class="chat__header-text">
                            <h2 class="chat__header-title">Counselor Chat</h2>
                            <div class="chat__header-status">
                                {% if report.assigned_to %}
                                    <span>{{ report.assigned_to.get_full_name|default:report.assigned_to.username }}</span>
                                    <span>Typically responds within a day</span>
                                {% else %}
                                    <span>Waiting for counselor assignment</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="chat__header-meta">
                        <span class="badge rounded-pill bg-light text-dark">Report #{{ report.id }}</span>
                        <span>Status: {{ report.get_status_display }}</span>
                        <span>Updated {{ report.updated_at|default:report.created_at|date:"M j, Y" }}</span>
                    </div>
                    </header>
                <div class="chat__scroll" data-chat-scroll aria-live="polite">
                    <ul class="chat__list" data-chat-list role="log" aria-live="polite">
                        {% if chat_messages %}
                            {% for message in chat_messages %}
                                {% ifchanged message.timestamp|date:'Y-m-d' %}
                                    <li class="chat__divider" role="presentation">
                                        <time datetime="{{ message.timestamp|date:'Y-m-d' }}">{{ message.timestamp|date:'l, F j' }}</time>
                                    </li>
                                {% endifchanged %}
                                {% include 'partials/chat_message.html' with message=message viewer=request.user report=report %}
                                {% for reply in message.replies.all %}
                                    {% ifchanged reply.timestamp|date:'Y-m-d' %}
                                        {% if message.timestamp|date:'Y-m-d' != reply.timestamp|date:'Y-m-d' or not forloop.first %}
                                            <li class="chat__divider" role="presentation">
                                                <time datetime="{{ reply.timestamp|date:'Y-m-d' }}">{{ reply.timestamp|date:'l, F j' }}</time>
                                            </li>
                                        {% endif %}
                                    {% endifchanged %}
                                    {% include 'partials/chat_message.html' with message=reply viewer=request.user report=report is_reply=True %}
                                {% endfor %}
                            {% endfor %}
                        {% else %}
                            <li class="chat__empty">
                                <i class="fas fa-comments" aria-hidden="true"></i>
                                <p>No messages yet. You can reach out once a counselor is assigned.</p>
                            </li>
                        {% endif %}
                    </ul>
                </div>
                <footer class="chat__footer">
                    {% if report.assigned_to %}
                        <form method="post" enctype="multipart/form-data" class="chat__composer" data-chat-composer novalidate>
                            {% csrf_token %}
                            {% if msg_form.non_field_errors %}
                                <div class="chat__errors">
                                    {% for error in msg_form.non_field_errors %}<span>{{ error }}</span>{% endfor %}
                                </div>
                            {% endif %}
                            <input
                                type="hidden"
                                name="{{ msg_form.parent_id.html_name }}"
                                id="{{ msg_form.parent_id.id_for_label }}"
                                value="{{ msg_form.parent_id.value|default_if_none:'' }}"
                                data-chat-parent-input="true"
                            />

                            <div class="chat__reply-indicator" data-chat-reply-indicator role="status">
                                <span>Replying to <strong data-chat-reply-name></strong></span>
                                <button type="button" class="chat__action" data-chat-reply-cancel>Cancel</button>
                            </div>
                            <div class="chat__input">
                                <div class="chat__toolbar">
                                    <button type="button" class="chat__icon-btn" data-chat-emoji title="Insert emoji" aria-label="Insert emoji">
                                        <i class="far fa-face-smile" aria-hidden="true"></i>
                                    </button>
                                    <button type="button" class="chat__icon-btn" data-chat-attach-trigger aria-controls="{{ msg_form.attachment.id_for_label }}" title="Attach file" aria-label="Attach a file">
                                        <i class="fas fa-paperclip" aria-hidden="true"></i>
                                        </button>
                                </div>
                                <textarea
                                    id="{{ msg_form.message.id_for_label }}"
                                    name="{{ msg_form.message.name }}"
                                    class="chat__textarea"
                                    placeholder="Write a message"
                                    aria-label="Type your message"
                                    data-chat-textarea="true"
                                    {% if msg_form.message.field.required %}required{% endif %}
                                    {% if msg_form.message.errors %}aria-invalid="true"{% endif %}
                                >{{ msg_form.message.value|default_if_none:"" }}</textarea>
                                <button type="submit" class="chat__send" name="send_msg" aria-label="Send message">
                                    <i class="fas fa-paper-plane" aria-hidden="true"></i>
                                </button>
                            </div>
                            {% with widget=msg_form.attachment.field.widget %}
                                <input
                                    type="file"
                                    id="{{ msg_form.attachment.id_for_label }}"
                                    name="{{ msg_form.attachment.name }}"
                                    class="visually-hidden"
                                    data-chat-attachment="true"
                                    {% if widget.attrs.accept %}accept="{{ widget.attrs.accept }}"{% endif %}
                                    {% if widget.attrs.multiple %}multiple{% endif %}
                                    {% if msg_form.attachment.field.required %}required{% endif %}
                                >
                            {% endwith %}

                            <p class="chat__attachment-hint" data-chat-attachment-feedback>You can attach PDFs or images as supporting evidence.</p>

                            {% if msg_form.message.errors or msg_form.attachment.errors %}
                                <div class="chat__errors">
                                    {% for error in msg_form.message.errors %}<span>{{ error }}</span>{% endfor %}
                                    {% for error in msg_form.attachment.errors %}<span>{{ error }}</span>{% endfor %}
                                </div>
                            {% endif %}
                        </form>
                    {% else %}
                        <p class="text-muted mb-0">Your case is being reviewed. Messaging will open once a counselor is assigned.</p>
                    {% endif %}
                </footer>
            </section>
        </section>
    </div>
</div>

{% endblock %}