<!DOCTYPE html>
{% load static %}
<html lang="en" data-theme-state="{{ request.session.theme|default:'auto' }}" data-bs-theme="{{ request.session.theme|default:'light' }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Bullying Awareness & Support Platform{% endblock %}</title>
    
    <meta name="color-scheme" content="light dark">

    <script>
        (function () {
            const savedTheme = '{{ request.session.theme|default:"" }}';
            const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
            const themeState = savedTheme || 'auto';
            const theme = savedTheme || (prefersDark ? 'dark' : 'light');
            document.documentElement.setAttribute('data-bs-theme', theme);
            document.documentElement.setAttribute('data-theme-state', themeState);
            document.documentElement.style.colorScheme = theme;
        })();
    </script>


    <!-- Bootstrap CSS -->
        <!-- Bootstrap CSS with support for light and dark modes -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <link rel="stylesheet" href="{% static 'css/messages.css' %}">
    <link rel="stylesheet" href="{% static 'css/profile.css' %}">
    
    {% block extra_head %}{% endblock %}
</head>
<body class="d-flex flex-column min-vh-100">
    <!-- Skip to content link for accessibility -->
    <a class="skip-link" href="#main-content">Skip to main content</a>
    
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light">
        <div class="container-xxl">
            <a class="navbar-brand d-flex align-items-center" href="{% url 'index' %}">
                <span class="d-inline-flex align-items-center justify-content-center rounded-4 bg-primary bg-opacity-10 text-primary me-2" style="width: 44px; height: 44px;">
                    <i class="fas fa-shield-alt"></i>
                </span>
                <span class="fs-4">Safe Campus</span>
            </a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto gap-1">
                    
                {% if user.is_authenticated %}
                <!-- Admin Login -->
                {% if user.is_superuser %}
                <li class="nav-item"><a class="nav-link {% if request.resolver_match.url_name == 'admin_dashboard' %}active{% endif %}" href="{% url 'admin_dashboard' %}"><i class="fas fa-chart-line me-1"></i>Dashboard</a></li>
                <li class="nav-item"><a class="nav-link {% if request.resolver_match.url_name == 'admin_reports' %}active{% endif %}" href="{% url 'admin_reports' %}"><i class="fas fa-inbox me-1"></i>Reports{% if admin_alerts %} <span class="badge bg-danger ms-1">{{ admin_alerts }}</span>{% endif %}</a></li>
                <li class="nav-item"><a class="nav-link {% if request.resolver_match.url_name == 'admin_case_assignment' %}active{% endif %}" href="{% url 'admin_case_assignment' %}"><i class="fas fa-user-check me-1"></i>Case Assignment</a></li>
                <li class="nav-item"><a class="nav-link {% if request.resolver_match.url_name == 'admin_analytics' %}active{% endif %}" href="{% url 'admin_analytics' %}"><i class="fas fa-chart-pie me-1"></i>Analytics</a></li>
                <li class="nav-item"><a class="nav-link {% if request.resolver_match.url_name == 'admin_awareness' %}active{% endif %}" href="{% url 'admin_awareness' %}"><i class="fas fa-lightbulb me-1"></i>Awareness</a></li>
                <li class="nav-item"><a class="nav-link {% if request.resolver_match.url_name == 'admin_user_management' %}active{% endif %}" href="{% url 'admin_user_management' %}"><i class="fas fa-users-cog me-1"></i>Users</a></li>
                <!-- Counselor Login -->
                {% elif user.is_staff %}
                <li class="nav-item"><a class="nav-link {% if request.resolver_match.url_name == 'counselor_dashboard' %}active{% endif %}" href="{% url 'counselor_dashboard' %}"><i class="fas fa-gauge me-1"></i>Dashboard</a></li>
                <li class="nav-item"><a class="nav-link {% if request.resolver_match.url_name == 'counselor_my_cases' %}active{% endif %}" href="{% url 'counselor_my_cases' %}"><i class="fas fa-briefcase me-1"></i>My Cases</a></li>
                <li class="nav-item"><a class="nav-link {% if request.resolver_match.url_name == 'counselor_invitations' %}active{% endif %}" href="{% url 'counselor_invitations' %}"><i class="fas fa-handshake me-1"></i>Invitations</a></li>
                <li class="nav-item"><a class="nav-link {% if request.resolver_match.url_name == 'counselor_messages' %}active{% endif %}" href="{% url 'counselor_messages' %}"><i class="fas fa-comments me-1"></i>Messages{% if unread_messages %} <span class="badge bg-danger ms-1">{{ unread_messages }}</span>{% endif %}</a></li>
                <li class="nav-item"><a class="nav-link {% if request.resolver_match.url_name == 'counselor_analytics' %}active{% endif %}" href="{% url 'counselor_analytics' %}"><i class="fas fa-chart-bar me-1"></i>Analytics</a></li>
                <li class="nav-item"><a class="nav-link {% if request.resolver_match.url_name == 'awareness' %}active{% endif %}" href="{% url 'awareness' %}"><i class="fas fa-lightbulb me-1"></i>Awareness</a></li>
                {% else %}
                <!-- User with acc -->
                <li class="nav-item"><a class="nav-link {% if request.resolver_match.url_name == 'index' %}active{% endif %}" href="{% url 'index' %}"><i class="fas fa-house me-1"></i>Home</a></li>
                <li class="nav-item"><a class="nav-link {% if request.resolver_match.url_name == 'submit_report' %}active{% endif %}" href="{% url 'submit_report' %}"><i class="fas fa-bullhorn me-1"></i>Report</a></li>
                <li class="nav-item"><a class="nav-link {% if request.resolver_match.url_name == 'track_report' %}active{% endif %}" href="{% url 'track_report' %}"><i class="fas fa-map-location-dot me-1"></i>Track</a></li>
                <li class="nav-item"><a class="nav-link {% if request.resolver_match.url_name == 'dashboard' %}active{% endif %}" href="{% url 'dashboard' %}"><i class="fas fa-gauge me-1"></i>Dashboard</a></li>
                <li class="nav-item"><a class="nav-link {% if request.resolver_match.url_name == 'user_messages' %}active{% endif %}" href="{% url 'user_messages' %}"><i class="fas fa-comments me-1"></i>Messages{% if unread_messages %} <span class="badge bg-danger ms-1">{{ unread_messages }}</span>{% endif %}</a></li>
                <li class="nav-item"><a class="nav-link {% if request.resolver_match.url_name == 'awareness' %}active{% endif %}" href="{% url 'awareness' %}"><i class="fas fa-lightbulb me-1"></i>Awareness</a></li>
                <li class="nav-item"><a class="nav-link {% if request.resolver_match.url_name == 'awareness' %}active{% endif %}" href="{% url 'awareness' %}#support"><i class="fas fa-hands-helping me-1"></i>Support</a></li>
                {% endif %}
                {% else %}
                <!-- User without acc -->
                <li class="nav-item"><a class="nav-link {% if request.resolver_match.url_name == 'index' %}active{% endif %}" href="{% url 'index' %}"><i class="fas fa-house me-1"></i>Home</a></li>
                <li class="nav-item"><a class="nav-link {% if request.resolver_match.url_name == 'report_anonymous' %}active{% endif %}" href="{% url 'report_anonymous' %}"><i class="fas fa-bullhorn me-1"></i>Report</a></li>
                <li class="nav-item"><a class="nav-link {% if request.resolver_match.url_name == 'track_report' %}active{% endif %}" href="{% url 'track_report' %}"><i class="fas fa-map-location-dot me-1"></i>Track</a></li>
                <li class="nav-item"><a class="nav-link {% if request.resolver_match.url_name == 'awareness' %}active{% endif %}" href="{% url 'awareness' %}"><i class="fas fa-lightbulb me-1"></i>Awareness</a></li>
                {% endif %}

                </ul>
                
                <ul class="navbar-nav align-items-center gap-2">
                    <!-- Theme Toggle Button -->
                    <li class="nav-item">
                        <button class="btn btn-outline-light d-flex align-items-center gap-2" id="theme-toggle" onclick="toggleTheme()" aria-label="Toggle theme" aria-pressed="false">
                            <i class="fas fa-sun" id="theme-icon"></i>
                            <span id="theme-label" class="fw-semibold"></span>
                        </button>
                    </li>
                    
                    {% if user.is_authenticated %}
                    <!-- Admin Login -->
                        {% if user.is_superuser %}
                        <li class="nav-item"><a class="nav-link {% if request.resolver_match.url_name == 'admin_profile' %}active{% endif %}" href="{% url 'admin_profile' %}"><i class="fas fa-user-circle me-1"></i>Profile</a></li>
                        <li class="nav-item"><a class="nav-link" href="{% url 'logout' %}"><i class="fas fa-sign-out-alt me-1"></i>Logout</a></li>
                        <!-- Counselor Login -->
                        {% elif user.is_staff %}
                        <li class="nav-item"><a class="nav-link {% if request.resolver_match.url_name == 'counselor_profile' %}active{% endif %}" href="{% url 'counselor_profile' %}"><i class="fas fa-user-circle me-1"></i>Profile</a></li>
                        <li class="nav-item"><a class="nav-link" href="{% url 'logout' %}"><i class="fas fa-sign-out-alt me-1"></i>Logout</a></li>
                        {% else %}
                        <li class="nav-item"><a class="nav-link {% if request.resolver_match.url_name == 'profile' %}active{% endif %}" href="{% url 'profile' %}"><i class="fas fa-user-circle me-1"></i>Profile</a></li>
                        <li class="nav-item"><a class="nav-link" href="{% url 'logout' %}"><i class="fas fa-sign-out-alt me-1"></i>Logout</a></li>
                        {% endif %}
                    {% else %}
                        <li class="nav-item"><a class="nav-link {% if request.resolver_match.url_name == 'login' %}active{% endif %}" href="{% url 'login' %}"><i class="fas fa-sign-in-alt me-1"></i>Login</a></li>
                        <li class="nav-item"><a class="nav-link {% if request.resolver_match.url_name == 'register' %}active{% endif %}" href="{% url 'register' %}"><i class="fas fa-user-plus me-1"></i>Register</a></li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </nav>
<!-- Impersonate User -->
    {% if request.session.impersonator_id %}
    <div class="border-bottom border-warning-subtle bg-warning-subtle text-warning-emphasis py-3" role="status" aria-live="polite">
        <div class="container-xxl d-flex flex-wrap align-items-center justify-content-between gap-3">
            <div>
                <strong>Impersonation active:</strong>
                You are currently acting as
                <span class="fw-semibold">{{ user.get_full_name|default:user.username }}</span>.
                <span class="text-muted small ms-1">Signed in originally as {{ request.session.impersonator_name }}</span>
            </div>
            <form method="post" action="{% url 'admin_stop_impersonation' %}" class="d-flex align-items-center gap-2">
                {% csrf_token %}
                <input type="hidden" name="next" value="{{ request.get_full_path }}">
                <button type="submit" class="btn btn-sm btn-warning">
                    <i class="fas fa-user-shield me-1"></i>Return to admin
                </button>
            </form>
        </div>
    </div>
    {% endif %}

    <!-- 2FA Authentication Enable -->
    {% block pre_content_banner %}
    {% if enable_2fa_banner %}
    {#
        Global reminder for users who have not yet enabled 2FA.  Adjust the
        message, link, or styling here to change how the banner is presented.
    #}
    <div class="border-bottom border-warning-subtle bg-warning-subtle text-warning-emphasis py-3" role="status" aria-live="polite">
        <div class="container-xxl d-flex flex-column flex-lg-row align-items-lg-center justify-content-between gap-3">
            <div>
                <strong>üîê‚ÄØEnable‚ÄØ2FA‚ÄØto‚ÄØprotect‚ÄØstudent‚ÄØconfidentiality.</strong>
                <div class="small text-muted">Two-factor authentication keeps sensitive case details and reports secure.</div>
            </div>
            <div>
                {% if enable_2fa_setup_url %}
                <a class="btn btn-sm btn-warning text-warning-emphasis fw-semibold" href="{{ enable_2fa_setup_url }}">
                    Enable 2FA now
                </a>
                {% else %}
                <span class="badge text-bg-warning text-warning-emphasis fw-semibold">
                    Contact support to finish enabling 2FA
                </span>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}
    {% endblock %}


    <!-- Flash Messages -->
{# Django flash/messages #}
{% if messages %}
  <div class="container mt-3">
    {% for message in messages %}
      {# Map Django 'error' -> Bootstrap 'danger' #}
      {% if message.tags == 'error' %}
        {% with level='danger' %}
          <div class="alert alert-{{ level }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endwith %}
      {% else %}
        <div class="alert alert-{{ message.tags|default:'info' }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endif %}
    {% endfor %}
  </div>
{% endif %}


    <!-- Main Content -->
    <main id="main-content" class="flex-grow-1">
        {% block content %}{% endblock %}
    </main>

    <!-- Footer -->
    <footer class="py-5 mt-auto">
        <div class="container-xxl">
            <div class="row g-4 align-items-center">
                <div class="col-lg-6">
                    <h5 class="mb-3">Safe Campus Platform</h5>
                    <p class="mb-2">Creating a safer, more inclusive university environment for all students.</p>
                    <p class="mb-0 small text-muted">&copy; {% now "Y" %} Safe Campus Initiative. All rights reserved.</p>
                </div>
                <div class="col-md-6 text-md-end">
                    <div class="alert alert-urgent d-inline-block px-3 py-2 mb-0">
                      <a href="tel:1990" class="btn btn-priority-high"> <strong><i class="fas fa-phone me-1"></i> Emergency: 1990</strong></a>
                    </div>
                    <p class="mt-2 mb-0">
                        <a href="mailto:support@university.edu" class="btn btn-priority-medium"><small>
                            <i class="fas fa-envelope me-1"></i> support@university.edu
                        </small></a>
                    </p>
                </div>
            </div>
        </div>
    </footer>

    <!-- Back to top button -->
    <button type="button" id="back-to-top" class="btn btn-primary rounded-circle" aria-label="Back to top">
        <i class="fas fa-arrow-up"></i>
    </button>

    {% if user.is_authenticated and user.is_staff %}
    <div id="notification-toasts" class="toast-container position-fixed bottom-0 end-0 p-3" aria-live="polite" aria-atomic="true"></div>
    {% endif %}

    <!-- Global confirmation modal -->
    <div class="modal fade" id="confirmationModal" tabindex="-1" aria-labelledby="confirmationModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmationModalLabel">Please Confirm</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body"></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmModalSubmit">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Theme Toggle Script -->
    <script>
        const themeStates = ['auto', 'dark', 'light'];
        let themeStateIndex = 0;
        let themeState = 'auto';
        let systemPrefersDark;
        let systemListenerAttached = false;

        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
        }

        function handleSystemThemeChange(event) {
            if (themeState === 'auto') {
                applyTheme(event.matches ? 'dark' : 'light');
            }
        }

        function enableSystemListener() {
            if (!systemPrefersDark || systemListenerAttached) {
                return;
            }
            if (systemPrefersDark.addEventListener) {
                systemPrefersDark.addEventListener('change', handleSystemThemeChange);
            } else if (systemPrefersDark.addListener) {
                systemPrefersDark.addListener(handleSystemThemeChange);
            }
            systemListenerAttached = true;
        }

        function disableSystemListener() {
            if (!systemPrefersDark || !systemListenerAttached) {
                return;
            }
            if (systemPrefersDark.removeEventListener) {
                systemPrefersDark.removeEventListener('change', handleSystemThemeChange);
            } else if (systemPrefersDark.removeListener) {
                systemPrefersDark.removeListener(handleSystemThemeChange);
            }
            systemListenerAttached = false;
        }

        function updateThemeToggleUI(theme) {
            const icon = document.getElementById('theme-icon');
            const toggleBtn = document.getElementById('theme-toggle');
            const navbar = document.querySelector('.navbar');
            const label = document.getElementById('theme-label');
            if (icon) {
                const iconClass = themeState === 'auto'
                    ? 'fas fa-circle-half-stroke'
                    : (theme === 'dark' ? 'fas fa-sun' : 'fas fa-moon');
                icon.className = iconClass;
                icon.classList.add('rotate');
                setTimeout(() => icon.classList.remove('rotate'), 300);
            }
            if (toggleBtn) {
                const isDark = theme === 'dark';
                toggleBtn.classList.toggle('btn-outline-light', isDark);
                toggleBtn.classList.toggle('btn-outline-dark', !isDark);
                toggleBtn.setAttribute('aria-pressed', themeState === 'auto' ? 'mixed' : String(isDark));
                const nextState = themeStates[(themeStateIndex + 1) % themeStates.length];
                const nextLabel = nextState === 'auto' ? 'auto mode' : `${nextState} mode`;
                toggleBtn.setAttribute('title', `Switch theme (next: ${nextLabel})`);
                const ariaLabel = themeState === 'auto'
                    ? 'Theme toggle, following system preference'
                    : `Theme toggle, ${isDark ? 'dark' : 'light'} mode enabled`;
                toggleBtn.setAttribute('aria-label', ariaLabel);
            }
            if (label) {
                label.textContent = themeState === 'auto' ? 'Auto' : (theme === 'dark' ? 'Dark' : 'Light');
            }
            if (navbar) {
                navbar.classList.toggle('navbar-dark', theme === 'dark');
                navbar.classList.toggle('navbar-light', theme === 'light');
            }
        }

            function persistTheme(state) {
            if (typeof fetch !== 'function') {
                return;
        }

        fetch('{% url "set_theme" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({ theme: state })
            });
        }

        function applyTheme(theme) {
            document.documentElement.setAttribute('data-bs-theme', theme);
            document.documentElement.setAttribute('data-theme-state', themeState);
            document.documentElement.style.colorScheme = theme;
            updateThemeToggleUI(theme);
        }

        function toggleTheme() {
            themeStateIndex = (themeStateIndex + 1) % themeStates.length;
            themeState = themeStates[themeStateIndex];

            if (themeState === 'auto') {
                enableSystemListener();
                const theme = systemPrefersDark && systemPrefersDark.matches ? 'dark' : 'light';
                applyTheme(theme);
                persistTheme('auto');
            } else {
                disableSystemListener();
                applyTheme(themeState);
                persistTheme(themeState);
            }
        }

        // Initialize theme on page load
        document.addEventListener('DOMContentLoaded', function() {
            systemPrefersDark = window.matchMedia ? window.matchMedia('(prefers-color-scheme: dark)') : null;
            const storedTheme = '{{ request.session.theme|default:"" }}'.trim();
            if (storedTheme === 'dark' || storedTheme === 'light') {
                themeState = storedTheme;
            } else {
                themeState = 'auto';
            }
            themeStateIndex = themeStates.indexOf(themeState);
            if (themeStateIndex === -1) {
                themeState = 'auto';
                themeStateIndex = 0;
            }

            const initialTheme = themeState === 'auto'
                ? ((systemPrefersDark && systemPrefersDark.matches) ? 'dark' : 'light')
                : themeState;

            if (themeState === 'auto') {
                enableSystemListener();
            } else {
                disableSystemListener();
            }

            applyTheme(initialTheme);

            const backToTop = document.getElementById('back-to-top');
            if (backToTop) {
                window.addEventListener('scroll', function () {
                    if (window.scrollY > 280) {
                        backToTop.classList.add('show');
                    } else {
                        backToTop.classList.remove('show');
                    }
                });

                backToTop.addEventListener('click', function () {
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                });
            }
        });
    </script>

    <script src="{% static 'js/messages.js' %}" defer></script>
    <script src="{% static 'js/profile.js' %}" defer></script>
    
        <!-- Auto-dismiss flash messages -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            setTimeout(function () {
                document.querySelectorAll('.alert-dismissible').forEach(function (alert) {
                    var alertInstance = bootstrap.Alert.getOrCreateInstance(alert);
                    alertInstance.close();
                });
            }, 5000);
        });
    </script>

     <!-- Centralized form confirmation -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            let formToSubmit;
            document.querySelectorAll('form[data-confirm]').forEach(function (form) {
                form.addEventListener('submit', function (e) {
                    e.preventDefault();
                    formToSubmit = form;
                    const message = form.getAttribute('data-confirm');
                    document.querySelector('#confirmationModal .modal-body').textContent = message || 'Are you sure?';
                    const modal = new bootstrap.Modal(document.getElementById('confirmationModal'));
                    modal.show();
                });
            });
            document.getElementById('confirmModalSubmit').addEventListener('click', function () {
                if (formToSubmit) {
                    formToSubmit.submit();
                }
            });
        });
    </script>

    <!-- Custom JS -->
    <script src="{% static 'js/main.js' %}"></script>

{% if user.is_authenticated and user.is_staff %}
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const container = document.getElementById('notification-toasts');
            if (!container || typeof bootstrap === 'undefined') {
                return;
            }

            const MAX_VISIBLE_TOASTS = 3;
            const AUTO_HIDE_MS = 10000;
            const protocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
            const socket = new WebSocket(`${protocol}://${window.location.host}/ws/notifications/`);

            const renderToast = (data) => {
                while (container.children.length >= MAX_VISIBLE_TOASTS) {
                    container.firstElementChild.remove();
                }

                const toastEl = document.createElement('div');
                toastEl.className = 'toast notification-toast shadow-lg border-0 fade';
                toastEl.setAttribute('role', 'alert');
                toastEl.setAttribute('aria-live', 'assertive');
                toastEl.setAttribute('aria-atomic', 'true');
                toastEl.dataset.bsAutohide = 'true';
                toastEl.dataset.bsDelay = AUTO_HIDE_MS;

                const header = document.createElement('div');
                header.className = 'toast-header d-flex align-items-center';

                const icon = document.createElement('span');
                icon.className = 'toast-icon';
                icon.textContent = data.icon || 'üîî';
                header.appendChild(icon);

                const title = document.createElement('div');
                title.className = 'me-auto';
                title.textContent = data.title || 'New notification';
                header.appendChild(title);

                const timestamp = document.createElement('small');
                timestamp.className = 'text-muted ms-3';
                timestamp.textContent = new Intl.DateTimeFormat(undefined, {
                    hour: '2-digit',
                    minute: '2-digit'
                }).format(new Date());
                header.appendChild(timestamp);

                const closeBtn = document.createElement('button');
                closeBtn.type = 'button';
                closeBtn.className = 'btn-close';
                closeBtn.setAttribute('data-bs-dismiss', 'toast');
                closeBtn.setAttribute('aria-label', 'Dismiss notification');
                header.appendChild(closeBtn);

                const body = document.createElement('div');
                body.className = 'toast-body';

                if (data.body) {
                    const bodyText = document.createElement('p');
                    bodyText.className = 'mb-0';
                    bodyText.textContent = data.body;
                    body.appendChild(bodyText);
                }

                if (data.url) {
                    const actionRow = document.createElement('div');
                    actionRow.className = 'mt-3 d-flex gap-2';
                    const primaryAction = document.createElement('a');
                    primaryAction.href = data.url;
                    primaryAction.className = 'btn btn-sm btn-primary';
                    primaryAction.textContent = data.cta || 'Open case';
                    actionRow.appendChild(primaryAction);
                    body.appendChild(actionRow);
                    toastEl.addEventListener('click', (event) => {
                        if (!event.target.closest('a, button')) {
                            primaryAction.click();
                        }
                    });
                }

                const progress = document.createElement('div');
                progress.className = 'toast-progress';
                progress.style.animationDuration = `${AUTO_HIDE_MS}ms`;

                toastEl.appendChild(header);
                toastEl.appendChild(body);
                toastEl.appendChild(progress);
                container.appendChild(toastEl);

                const toast = bootstrap.Toast.getOrCreateInstance(toastEl, {
                    autohide: true,
                    delay: AUTO_HIDE_MS
                });

                let hideTimer = setTimeout(() => {
                    toast.hide();
                }, AUTO_HIDE_MS);

                toastEl.addEventListener('mouseenter', () => {
                    clearTimeout(hideTimer);
                });

                toastEl.addEventListener('mouseleave', () => {
                    clearTimeout(hideTimer);
                    hideTimer = setTimeout(() => toast.hide(), AUTO_HIDE_MS);
                });

                toastEl.addEventListener('hidden.bs.toast', () => {
                    clearTimeout(hideTimer);
                    toastEl.remove();
                });

                toast.show();
            };

            socket.addEventListener('message', (event) => {
                try {
                    const data = JSON.parse(event.data);
                    renderToast(data);
                } catch (error) {
                    console.error('Failed to render notification', error);
                }
            });

            socket.addEventListener('close', () => {
                console.debug('Notifications connection closed');
            });

            socket.addEventListener('error', (error) => {
                console.error('Notifications connection error', error);
            });
        });
    </script>
    {% endif %}
    
    <!-- Auttomatically Logout -->
    {% if user.is_authenticated and auto_logout_timeout_seconds %}
    <script>
        (function () {
            const timeoutSeconds = {{ auto_logout_timeout_seconds|default:0 }};
            if (!timeoutSeconds || timeoutSeconds <= 0) {
                return;
            }

            const redirectUrl = "{% url 'index' %}";
            let timerId;

            const triggerAutoLogout = () => {
                window.location.replace(redirectUrl);
            };

            const resetInactivityTimer = () => {
                window.clearTimeout(timerId);
                timerId = window.setTimeout(triggerAutoLogout, timeoutSeconds * 1000);
            };

            const activityEvents = ['click', 'mousemove', 'keydown', 'scroll', 'touchstart'];
            activityEvents.forEach((eventName) => {
                const usePassive = eventName === 'scroll' || eventName === 'touchstart';
                const options = usePassive ? { passive: true } : false;
                document.addEventListener(eventName, resetInactivityTimer, options);
            });

            window.addEventListener('focus', resetInactivityTimer);
            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'visible') {
                    resetInactivityTimer();
                }
            });

            resetInactivityTimer();
        })();
    </script>
    {% endif %}

    {% block extra_scripts %}{% endblock %}
</body>
</html>
