{% extends "base.html" %}

{#
  Project-level copy of the enable-two-factor template.  The core app ships
  with the same markup under ``tccweb/core/templates/core/`` so deployments
  that rely on Django's app template loader (without adding this directory to
  ``TEMPLATES['DIRS']``) still render the guidance page.  Update both copies
  together when making content changes.
#}

{% block title %}Enable Two-Factor Authentication{% endblock %}

{% block content %}
<div class="container-xxl py-5">
    <div class="row justify-content-center">
        <div class="col-xl-8 col-lg-9">
            <div class="card shadow-sm border-0">
                <div class="card-body p-5">
                    <h1 class="h3 mb-4">Secure your account with two-factor authentication</h1>
                    <p class="lead">Two-factor authentication (2FA) ensures that even if your password is compromised, only you can unlock sensitive student information.</p>

                    {% if two_factor_enabled %}
                    <div class="alert alert-success d-flex align-items-start gap-3" role="status">
                        <i class="fas fa-lock fa-lg mt-1"></i>
                        <div>
                            Your authenticator app is connected. You will be prompted for a six-digit code every time you sign in.
                        </div>
                    </div>

                    <h2 class="h5 mt-4">Configured authenticators</h2>
                    <ul class="list-group mb-4">
                        {% for device in two_factor_devices %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span class="fw-semibold">{{ device.name|default:'Authenticator app' }}</span>
                            <span class="badge text-bg-success">Active</span>
                        </li>
                        {% empty %}
                        <li class="list-group-item text-muted">Authenticator app configured.</li>
                        {% endfor %}
                    </ul>

                    <form method="post" class="d-inline">
                        {% csrf_token %}
                        {% if two_factor_next_value %}
                        <input type="hidden" name="next" value="{{ two_factor_next_value }}">
                        {% endif %}
                        <input type="hidden" name="action" value="disable">
                        <button type="submit" class="btn btn-outline-danger">
                            Disable two-factor authentication
                        </button>
                    </form>
                    {% else %}
                    <div class="alert alert-warning d-flex align-items-start gap-3" role="status">
                        <i class="fas fa-shield-alt fa-lg mt-1"></i>
                        <div>
                            Follow the steps below to connect your authenticator app. You will need to enter a verification code before 2FA is activated.
                        </div>
                    </div>

                    <ol class="ps-4 mb-4">
                        <li class="mb-2">Install an authenticator app such as Microsoft Authenticator, Google Authenticator, Authy, or 1Password on your phone.</li>
                        <li class="mb-2">Scan the QR code below or choose “Enter key manually” and paste the setup key.</li>
                        <li class="mb-3">Enter the six-digit code generated by the app to confirm activation.</li>
                    </ol>

                    {% if two_factor_otpauth_url or two_factor_manual_key %}
                    <div class="p-4 bg-body-secondary rounded-3 mb-4">
                        <h2 class="h6 fw-semibold mb-3">Authenticator setup details</h2>
                        {% if two_factor_qr_code_data_uri %}
                        <div class="text-center mb-3">
                            <img src="{{ two_factor_qr_code_data_uri }}" alt="Scan this QR code with your authenticator app" class="img-fluid" style="max-width: 260px;">
                        </div>
                        <p class="small text-muted text-center mb-3">Open your authenticator app, choose “Scan QR code,” and point it at the image above.</p>
                        {% elif two_factor_otpauth_url %}
                        <p class="small text-muted mb-2">If your app supports QR codes, use the following link:</p>
                        <code class="d-block text-break mb-3">{{ two_factor_otpauth_url }}</code>
                        {% endif %}
                        {% if two_factor_manual_key %}
                        <p class="small text-muted mb-2">Manual setup key:</p>
                        <div class="fs-5 fw-semibold" style="letter-spacing: 0.2em;">{{ two_factor_manual_key_spaced }}</div>
                        {% endif %}
                    </div>
                    {% endif %}

                    <form method="post" class="mb-3">
                        {% csrf_token %}
                        {% if two_factor_next_value %}
                        <input type="hidden" name="next" value="{{ two_factor_next_value }}">
                        {% endif %}
                        <input type="hidden" name="action" value="verify">
                        <div class="mb-3">
                            <label for="id_otp_token" class="form-label">Authenticator code</label>
                            <input type="text" name="otp_token" id="id_otp_token" inputmode="numeric" pattern="[0-9]*" maxlength="8" class="form-control" placeholder="Enter the 6-digit code" autocomplete="one-time-code" required>
                            <div class="form-text">Open {{ two_factor_device_label|default:'your authenticator app' }} and enter the current six-digit code.</div>
                        </div>
                        <button type="submit" class="btn btn-primary btn-lg">Confirm and enable 2FA</button>
                    </form>

                    <form method="post" class="d-inline">
                        {% csrf_token %}
                        {% if two_factor_next_value %}
                        <input type="hidden" name="next" value="{{ two_factor_next_value }}">
                        {% endif %}
                        <input type="hidden" name="action" value="refresh">
                        <button type="submit" class="btn btn-outline-secondary btn-sm">Generate a new setup key</button>
                    </form>
                    {% endif %}

                    <div class="mt-4">
                        <a href="{{ two_factor_return_url|default:two_factor_fallback_url }}" class="btn btn-secondary">
                            Return to previous page
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}