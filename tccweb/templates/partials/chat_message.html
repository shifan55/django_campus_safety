{% load chat_filters %}
<div class="chat-entry{% if message.sender_id == viewer.id %} chat-entry-self{% else %} chat-entry-other{% endif %}{% if is_reply %} chat-entry-reply{% endif %}">
    <div class="chat-avatar" aria-hidden="true">
        <span class="avatar-initial">
            {{ message.sender.get_full_name|default:message.sender.username|first|upper }}
        </span>
    </div>
    <div class="chat-content">
        <div class="chat-meta d-flex flex-wrap justify-content-between align-items-start gap-2">
            <div>
                <span class="chat-author fw-semibold">
                    {% if message.sender_id == report.assigned_to_id %}
                        Counselor
                    {% elif report.reporter and message.sender_id == report.reporter_id %}
                        Student
                    {% else %}
                        {{ message.sender.get_full_name|default:message.sender.username }}
                    {% endif %}
                </span>
                <span class="chat-time text-muted small ms-2">{{ message.timestamp|date:"M j, Y g:i a" }}</span>
            </div>
            {% if report.reporter and report.assigned_to %}
            <a href="#" class="small text-decoration-none reply-link" data-parent="{{ message.id }}" data-author="{% if message.sender_id == report.assigned_to_id %}Counselor{% elif report.reporter and message.sender_id == report.reporter_id %}Student{% else %}{{ message.sender.get_full_name|default:message.sender.username }}{% endif %}">
                Reply
            </a>
            {% endif %}
        </div>
        {% with body=message|decrypt:viewer %}
            <div class="chat-bubble{% if message.sender_id == viewer.id %} chat-bubble-self{% else %} chat-bubble-other{% endif %}">
                {% if body %}
                    {{ body|linebreaksbr }}
                {% elif message.attachment %}
                    <span class="fst-italic text-muted">Attachment shared</span>
                {% else %}
                    <span class="fst-italic text-muted">(No message content)</span>
                {% endif %}
            </div>
        {% endwith %}
        {% if message.attachment %}
            <div class="chat-attachment mt-2">
                <i class="fas fa-paperclip me-1" aria-hidden="true"></i>
                <a href="{{ message.attachment.url }}" target="_blank" rel="noopener" class="chat-attachment-link">
                    {{ message.attachment.name|cut:'chat_attachments/' }}
                </a>
            </div>
        {% endif %}
    </div>
</div>