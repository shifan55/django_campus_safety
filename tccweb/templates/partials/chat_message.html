{% load chat_filters %}
{% with is_self=message|is_sender:viewer %}
<li
    class="chat__item{% if is_self %} chat__item--sent{% else %} chat__item--recv{% endif %}{% if is_reply %} chat__item--reply{% endif %}"
    data-message-id="{{ message.id }}"
    role="listitem"
    aria-labelledby="chat-meta-{{ message.id }}"
>
    {% if not is_self %}
        <span class="chat__avatar" aria-hidden="true">
            {{ message.sender.get_full_name|default:message.sender.username|first|upper }}
        </span>
    {% endif %}
    <div class="chat__item-body" role="group" aria-label="Message from {{ message.sender.get_full_name|default:message.sender.username }}">
        <div
            class="chat__bubble{% if is_self %} chat__bubble--sent{% else %} chat__bubble--recv{% endif %}"
            id="chat-bubble-{{ message.id }}"
        >
            {% if is_reply %}
                <p class="chat__reply-label">Replying to a previous message</p>
            {% endif %}
            {% with body=message|decrypt:viewer %}
                {% if body %}
                    <div class="chat__text" id="chat-bubble-{{ message.id }}-content">{{ body|linebreaksbr }}</div>
                {% elif message.attachment %}
                    <div class="chat__text chat__text--muted">Attachment shared</div>
                {% else %}
                    <div class="chat__text chat__text--muted">(No message content)</div>
                {% endif %}
            {% endwith %}

        {% if message.attachment %}
                <div class="chat__attachment" aria-label="Attached file">
                    <i class="fas fa-paperclip" aria-hidden="true"></i>
                    <a
                        class="chat__attachment-link"
                        href="{{ message.attachment.url }}"
                        target="_blank"
                        rel="noopener"
                        download
                        aria-label="Download attachment: {{ message.attachment.name|cut:'chat_attachments/' }}"
                    >
                        {{ message.attachment.name|cut:'chat_attachments/' }}
                    </a>
                    <span class="visually-hidden">Opens in a new tab</span>
                </div>
            {% endif %}

            {% if message.emotion and message.emotion != 'neutral' or message.risk_level and message.risk_level != 'normal' %}
                <div class="chat__chips">
                    {% if message.emotion and message.emotion != 'neutral' %}
                        <span class="chat__chip chat__chip--emotion-{{ message.emotion }}">{{ message.get_emotion_display }}</span>
                    {% endif %}
                    {% if message.risk_level and message.risk_level != 'normal' %}
                        <span class="chat__chip chat__chip--risk-{{ message.risk_level }}">{{ message.get_risk_level_display }}</span>
                    {% endif %}
                </div>
            {% endif %}

        {% if message.emotion_explanation %}
                <p class="chat__insight">{{ message.emotion_explanation }}</p>
            {% endif %}
        </div>
        <div class="chat__meta" id="chat-meta-{{ message.id }}">
            <div class="chat__meta-group">
                {% if not is_self %}
                    <span class="chat__author">
                        {% if message.sender_id == report.assigned_to_id %}
                            Counselor
                        {% elif report.reporter and message.sender_id == report.reporter_id %}
                            Student
                        {% else %}
                            {{ message.sender.get_full_name|default:message.sender.username }}
                        {% endif %}
                    </span>
                {% endif %}
                <time class="chat__timestamp" datetime="{{ message.timestamp|date:'c' }}" title="{{ message.timestamp|date:'l, F j, Y g:i a' }}">
                    {{ message.timestamp|date:"M j, Y g:i a" }}
                </time>
            </div>
            {% if is_self %}
                <span class="chat__status">
                    {% if message.is_read %}
                        <i class="fas fa-check-double" aria-hidden="true"></i>
                        <span class="visually-hidden">Read</span>
                    {% else %}
                        <i class="fas fa-check" aria-hidden="true"></i>
                        <span class="visually-hidden">Sent</span>
                    {% endif %}
                </span>
            {% endif %}
            {% if report.reporter and report.assigned_to %}
                <div class="chat__actions">
                    <button
                        type="button"
                        class="chat__action"
                        data-chat-reply
                        data-parent="{{ message.id }}"
                        data-author="{% if message.sender_id == report.assigned_to_id %}Counselor{% elif report.reporter and message.sender_id == report.reporter_id %}Student{% else %}{{ message.sender.get_full_name|default:message.sender.username }}{% endif %}"
                        aria-label="Reply to this message"
                    >
                        <i class="fas fa-reply" aria-hidden="true"></i>
                        <span>Reply</span>
                    </button>
                </div>
            {% endif %}
        </div>
    </div>
</li>
{% endwith %}
